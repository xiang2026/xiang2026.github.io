{"title":"舒适窝的最后一块拼图--基于Rock64与Volumio的音频流媒体服务器","slug":"舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器","date":"2019-11-10T10:03:21.000Z","updated":"2019-11-11T13:29:20.702Z","comments":true,"path":"api/articles/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器.json","photos":[],"link":"","excerpt":" [Figure] }）。","covers":["/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/title.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/32.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/03.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/拓扑-old.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/拓扑-new.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0292.JPG","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0293.JPG","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/48.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0296.JPG","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/07.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/51.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/flush.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/32.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0297.JPG","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/02.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/wifi.jpg","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/55.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/43.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/48.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/TIM图片20191110202912.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/06.gif","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/TIM图片20191110203026.png","/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/../public/static/ac_sticker/44.gif"],"content":"<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/title.png\" alt=\"title\"></p>\n<p>因为没约到人<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/32.gif\" alt>，花费了一个周末，在家折腾了一下Rock64这块板子做音频流媒体数播，用来读取NAS里的音乐文件推送到我自己的DAC，同时可以兼顾手机无线和蓝牙的推流服务器。</p>\n<p>其实很早就有这个想法了，自从前段时间收了二手的NAS，把所有的资料都转移到NAS上之后，就开始想着把台机和电脑解耦开来，不然每次听歌都得开电脑在旁边待机，还是有点蛋疼的（我是有多强迫症<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/03.gif\" alt>）。</p>\n<a id=\"more\"></a>\n<p>其实很早就知道树莓派和Volumio系统了（其实还有个Moode，这个是其中一个大坑），在张大妈上也看过一些分享的帖子。因为之前在绿坛上看到过有人用Rock64这个开发板和魔改过的Moode做流媒体数播，帖子里不少人表示这套下的声音表现是好过树莓派（3B）与Volumio的组合的，因为树莓派3的usb总线与网络总线是复用的，因此在使用网络并使用usb输出的时候会造成信号损失。于是Rock64+Moode的草算是种下了。</p>\n<p>由于Moode官方只提供基于树莓派的系统内核，移植需要重新编译内核，因此这个事情就一直搁置了。恰巧前两天翻绿坛的老帖子，找到了那个之前做Moode系统移植的哥们的回复，发现了他们的群，下载到了今年7月新编译的系统版本。因此，搞一个Rock64+Moode的嵌入式系统做流媒体数字界面的项目提上日程。</p>\n<h2 id=\"整体架构\"><a href=\"#整体架构\" class=\"headerlink\" title=\"整体架构\"></a>整体架构</h2><p>目前我的房间的基本网络拓扑是下面这个样子的，NAS直接与路由连接，通过SMB的方式将下载目录共享出来，使得所有挂在路由器下面的设备可以直接访问NAS里面的资源。我正常的听歌是开电脑，foobar2000读取NAS里的音频文件，然后通过usb将数据传给DAC做数模转换并放大，同时电脑端负责播放的控制。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/拓扑-old.png\" alt=\"拓扑-old\"></p>\n<p>新的音频流媒体服务器加入后，拓扑结构会变成下面这个样子。原本读取NAS和传输数据到DAC的任务由音频流媒体服务器承担，同时流媒体服务器会在内网暴露一个控制的服务出来，任何可以访问这个服务的终端都可以完成对播放的控制工作，因此我可以不再限制于电脑，而是通过手机，ipad等其他终端对其进行控制。同时，服务还会附带DLAN和UPNP的流媒体功能，使我可以在任何接入这个网络的设备上向其推流播放。使用起来非常灵活。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/拓扑-new.png\" alt=\"拓扑-new\"></p>\n<h2 id=\"欢乐的踩坑\"><a href=\"#欢乐的踩坑\" class=\"headerlink\" title=\"欢乐的踩坑\"></a>欢乐的踩坑</h2><p>淘宝下单到货，一共花了两天。我买的Rock64 1G的版本，因为用途单一，只需要读取NAS上的数据并通过usb推送到我的DAC即可，因此内存不需要很大。同时一并购买了官方的亚克力壳子，想着装好直接挂桌面的下面，有个壳子还是能保护一下。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0292.JPG\" alt=\"IMG_0292\"></p>\n<p>拆包全家福，店主送了两散热片。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0293.JPG\" alt=\"IMG_0293\"></p>\n<p>1G版，当初去找店主问的时候，店主极力推荐2G的版本，然而想想要多100+就肉疼，最终还是买了这个，事后证明完全够用<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/48.gif\" alt>。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0296.JPG\" alt=\"IMG_0296\"></p>\n<p>（这个Silicon Delta。。。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/07.gif\" alt>）</p>\n<p>Moode的安装是非常方便的，因为系统是直接压好的镜像，所以只需要将系统的img文件烧录到tf卡里就行了，烧录完成之后就等于系统已经做好了，没有类似pc的安装的过程，这点还是很方便的。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/51.gif\" alt></p>\n<p>软件可以使用Etcher，界面简单直接，选择镜像文件就好。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/flush.png\" alt=\"flush\"></p>\n<p>插卡上电，看着灯闪起来，我的内心还小小的激动了一下，然后恶梦就开始了。。。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/32.gif\" alt></p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/IMG_0297.JPG\" alt=\"IMG_0297\"></p>\n<p>首先我发现Rock64这块板子没有板载无线网卡，由于我的NAS和路由器都扔客厅了，想要usb连接我的DAC，只能通过无线接入我的路由器。本来想着这群货各种吹Rock比树莓派好，想着树莓派有的这个怎么都得有吧，结果还是翻车了。。。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/02.gif\" alt></p>\n<p>于是飞速上网搞了块据说树莓派专用的usb无线网卡，兴冲冲插上，上电开机。结果这块网卡没办法在魔改的Moode系统上随系统启动，驱动是加载了，但内核分配不了正确的设备端口名称（正确的应该是wlan0，而我的下面永远是wlxe+mac地址组成的串）。经过我反复尝试，最终发现可以在启动完成后通过热插拔usb网卡进行正确的分配。但分配完成后不会自动连入wifi热点，需要我远程SSH到系统里执行命令连接。由于我之前说的原因，我没办法给这个开发板提供有线连接。事情就变成了我需要wifi–》wifi需要SSH设置–》SSH设置需要wifi连接的怪圈。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/wifi.jpg\" alt=\"wifi\"></p>\n<p>最终的解决方案是我写了一个python的脚本，通过系统的crontab去定时执行，每分钟检测下ifconfig wlan0命令的返回结果中是否分配了ip，如果没有的话则执行我写成脚本的连入wifi热点的脚本。这样就可以在系统启动后，通过热插拔的方式接入无线网络了。真是机智如我2333<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/55.gif\" alt></p>\n<p>然而下一个坑马上就来了，我发现这个无线网卡即使是在正常驱动和正确接入的情况下，还是会在一段时间之后造成系统死机。而且我发现我扫描添加的NAS文件并不能正常播放。日志里显示mount error，看样子是在将远程目录映射到本地的时候出了问题。</p>\n<p>没辙了，于是打算最后试一下Volumio系统，看到的评价是这个更好上手一些，心想这个至少应该少点坑。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/43.gif\" alt></p>\n<p>然后，照旧下载Volumio系统，刷机，上电开机。等等，居然有热点了？没想到直接就驱动成功了。飞速打开控制端，一切都比改版的Moode顺滑很多，音乐也可以正常播放了，舒坦了。然而12min后（我听完三首歌），一如之前的死机还是来了。一番google发现是网卡的驱动还是不对。linux 4.4以上针对我这块网卡有个新的驱动，模块是rtl8xxxu,通过lsmod可以看到rtl8xxxu被加载了，但网卡用的不是这个驱动，而是另外一个rtl8192cu模块。</p>\n<p>于是禁用rtl8192，重启，世界清净了~~<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/48.gif\" alt> &nbsp;&nbsp;&nbsp;  <img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/55.gif\" alt></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 禁用8192cu的模块</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"blacklist rtl8192cu\"</span> &gt;&gt; /etc/modprobe.d/blacklist-rtl819x.conf</span><br><span class=\"line\"><span class=\"comment\"># 启用8xxxu</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"rtl8xxxu\"</span> &gt;&gt; /etc/modules</span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">reboot now</span><br></pre></td></tr></table></figure>\n<p>开机后发现网卡貌似并没有使用rtl8xxxu的模块，但是正常驱动了，而且连续播放几小时之后也没出现过死机的情况了，nice~~</p>\n<p>最后看到扫描出来的专辑，听着音乐。还是有点小爽的。</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/TIM图片20191110202912.png\" alt=\"TIM图片20191110202912\"></p>\n<p>（梁阿姨当年的歌是真的少女，老夫的少女心啊<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/06.gif\" alt>）</p>\n<p><img src=\"/2019/11/10/舒适窝的最后一块拼图-基于Rock64与Volumio的音频流媒体服务器/TIM图片20191110203026.png\" alt=\"TIM图片20191110203026\"></p>\n<p>于是默默把线拉好，板子直接放桌子下面的吊篮里，也看不到，深藏功与名23333.</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>其实整个过程下来还算顺利，坑的点在于首先我自己没看清楚Datasheet，不知道Rock64这个板子没有wifi，而linux对于wifi的驱动又一向很烂。</p>\n<p>最后附上Rock64版的Volumio的下载，因为这个板子不是很常见，Volumio的官网没有为这个板子维护单独的分支，是在论坛里由单人进行维护的。</p>\n<p><a href=\"https://forum.volumio.org/volumio-rock64-t9467.html\" target=\"_blank\" rel=\"noopener\">点我去下载地址的帖子</a></p>\n<p>最后，千言万语总结成一句话：要是能重来，我要选树莓派。<img style=\"display:inline-block;vertical-align:-30px\" src=\"/static/ac_sticker/44.gif\" alt></p>\n","categories":[],"tags":[{"name":"系统搭建","slug":"系统搭建","count":1,"path":"api/tags/系统搭建.json"}]}